name: vTPM Integration Test on TDX server
on:
    push:
      paths-ignore:
        - "**.md"
    pull_request:
      paths-ignore:
        - "**.md"

env:
  AS: nasm
  RUST_TOOLCHAIN: nightly-2022-11-15
  TOOLCHAIN_PROFILE: minimal

jobs:
  system_compile:
    name: Run vTPM Integration Test
    runs-on: [self-hosted, vtpm]

    steps:
      - name: Checkout sources - vTpm
        uses: actions/checkout@v2
        with:
          submodules: recursive
      
      - name: Build vTPM td
        run: |
          rm -rf ../run-vtpm-td
          mkdir ../run-vtpm-td
          git submodule update --init --recursive
          bash sh_script/pre-build.sh
          bash sh_script/build.sh
          cp target/x86_64-unknown-none/release/vtpmtd.bin ../run-vtpm-td

      - name: Run test
        run: |
          pushd sh_script
          pytest -k "not stress"
          popd